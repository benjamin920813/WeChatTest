'use strict';

var co = require('co');
var request = require('co-request');
var debug = require("debug")('shoots-queue');

var util = {};
util.ajax = function*(appOptions, name, func, data) {
  var post = {
    app: {
      id: appOptions.id,
      secret: appOptions.secret,
      name: appOptions.name,
      config: appOptions.config
    },
    name: name,
    func: func,
    req: data

  };
  debug('post data:= ' + JSON.stringify(post));
  var response = yield request({
    method: 'POST',
    uri: appOptions.server + '/queue/api/handle',
    resolveWithFullResponse: true,
    body: post,
    json: true
  });

  debug('response := ' + JSON.stringify(response));
  if (response.statusCode == 200) {
    return response.body;
  } else if (response.statusCode == 204) {
    return null;
  } else {
    throw new Error(response);
  }
}
module.exports = util;
