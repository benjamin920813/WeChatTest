var mongo = require('shoots-mongo');
var cache = {};
var config = {};
var model = 'cache';
var EXPIRE = 24 * 60 * 60 * 1000; //1 days 
//db.cache.createIndex( { "expireAt": 1 }, { expireAfterSeconds: 0 })
var collection;


module.exports = function(appOptions) {
	config = appOptions;
	collection = mongo(appOptions).Collection(model);
	return cache;
}

/**
 设置cache
 key 会话的唯一值
 value 要保存的值
 expireAfterSeconds 多少秒后过期 default 1 days expired
*/
cache.set = function*(key, value, expireAfterSeconds) {
	var now = (new Date()).getTime();
	var expireAt = null;
	if (expireAfterSeconds) {
		expireAt = now + expireAfterSeconds * 1000;
	} else {
		expireAt = now + EXPIRE; // default 1 days expired
	}
	var doc = {
		key: key,
		val: value,
		expireAt: new Date(expireAt)
	};

	if (yield remove(key)) {
		result = yield collection.insert(doc);
		return result.errcode == 0;
	} else {
		return false;
	}
}

cache.get = function*(key) {
	var result = yield collection.findOne({
		key: key
	}, {
		val: 1
	});
	return result && result.errcode == 0 && result.data && result.data.val;
}

cache.remove = function*(key) {
	return yield remove(key);
}


function* remove(key) {
	var result = yield collection.remove({
		key: key
	});
	return result.errcode == 0;
}