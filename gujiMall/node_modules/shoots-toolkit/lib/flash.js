var cookies = require('./cookies');

var flash = {};
var options = {};

var flashMap = new Map();
module.exports = flash;

module.exports = function(appOptions) {
    options = appOptions;
    return flash;
}

flash.set = function(ctx, key, val) {
    var key = getRealKey(ctx, key);
    if (key) {
        flashMap.set(key, val);
        return true;
    }
    return false;
}

flash.get = function(ctx, key) {
    var key = getRealKey(ctx, key);
    if (key) {
        var result = flashMap.get(key);
        flashMap.delete(key);
        return result;
    }
    return null;
}

flash.has = function(ctx, key) {
    var key = getRealKey(ctx, key);
    if (key) {
        return flashMap.has(key);
    }
    return false;
}

function getRealKey(ctx, key) {
    var sessionId = cookies.get(ctx, options.cookied);
    if (sessionId) {
        return sessionId + key;
    }
    return null;
}